<!doctype html>
<meta charset=utf-8>
<body>
<script src="../dist/slowsearch-v1.js"></script>
<script src="../dist/slowsearch-v2.js"></script>
<script src="../dist/slowsearch-v3.js"></script>
<script src="../dist/slowsearch-v4.js"></script>
<script src="../dist/slowsearch-v5.js"></script>
<script src="../dist/slowsearch-v6.js"></script>
<script src="enwiki-articles.js"></script>
<script>
/* eslint-env browser es6 */
/* global texts:false */
/* eslint-disable no-console */
const indexMap = new Map();
const timingMap = new Map();
const status = (version, text) => document.querySelector('#v' + version + ' .status').textContent = text;
function test(version, count = 10) {
  status(version, 'indexing...');
  const start = Date.now();
  const searchFunc = window['slowsearch_v' + version];
  const promises = [];
  //let lastFinish = Date.now();
  const storedIndex = indexMap.get(version) || 0;
  if (version >= 3) {
    const documents = [];
    for (let i = storedIndex; i < storedIndex + count && i < texts.length; i++) {
      documents.push({text: texts[i]});
    }
    promises.push(searchFunc.batchAdd(documents, true));
  } else {
    for (let i = storedIndex; i < storedIndex + count && i < texts.length; i++) {
      promises.push(searchFunc.add({text: texts[i]}));
    //.then(event => {
      //console.log('promise done for text', i, '; uniqueTerms: ', event.uniqueTerms, '; internal time (since promise create): ', event.time, '; relative time since last promise: ', (Date.now() - lastFinish) + ' ms', '; relative time per uniqueTerm: ', ((Date.now() - lastFinish) / event.uniqueTerms) + ' ms');
      //lastFinish = Date.now();
    //}));
    //console.log('added promise for text ', i);
    }
  }
  indexMap.set(version, storedIndex + count);
  return Promise.all(promises).then(() => {
    const duration = Date.now() - start;
    const timings = (timingMap.get(version) || []);
    timings.push(duration);
    timingMap.set(version, timings);
    console.log('done with slowsearch v' + version, duration);
    status(version, 'index duration = ' + duration);
  }).catch(e => {
    console.log('error with slowsearch v' + version, e);
    status(version, 'index error ' + JSON.stringify(e));
  });
}

function drop(version) {
  status(version, 'dropping database...');
  const request = indexedDB.deleteDatabase('search-v' + version);
  request.onsuccess = () => {
    console.log('database v' + version + ' deleted');
    status(version, 'dropped DB');
  };
  request.onerror = (event) => {
    console.log('database v' + version + ' delete error', event);
    status(version, 'error dropping DB');
  }
}
function query(version, word = 'light') {
  status(version, 'searching...');
  const start = Date.now();
  const searchFunc = window['slowsearch_v' + version];
  searchFunc.searchSingleWord(word)
  .then(
    results => {
      const duration = Date.now() - start;
      console.log('query slowsearch v' + version + ' for "' + word + '"', duration, results);
      status(version, 'query time ' + duration + ' and ' + results.total + ' results (of which ' + results.documents.length + ' in result)');
  });
}
function createTestButton(text, func) {
  const btn = document.createElement('button');
  btn.textContent = text;
  btn.onclick = func;
  return btn;
}
[1,2,3,4,5,6].map(v => {
  const div = document.createElement('div');
  div.id = 'v' + v;
  div.textContent = 'V' + v + ': ';
  div.appendChild(createTestButton('Run (10 docs)', () => test(v)));
  div.appendChild(createTestButton('Drop DB', () => drop(v)));
  div.appendChild(createTestButton('Query', () => query(v)));
  const span = document.createElement('span');
  span.style.marginLeft = '0.5rem';
  span.className = 'status';
  div.appendChild(span);
  document.body.appendChild(div);
});
</script>
<br>
Open your console for output.<br>